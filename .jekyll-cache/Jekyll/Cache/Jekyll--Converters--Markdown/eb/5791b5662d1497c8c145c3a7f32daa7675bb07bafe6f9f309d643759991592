I"´+<h1 id="åœºæ™¯æè¿°">åœºæ™¯æè¿°</h1>
<p>å®¹å™¨å†…å¯ç”¨å†…å­˜è¿œæ²¡æœ‰è¾¾åˆ°cgroupé™åˆ¶ï¼Œå°±å·²ç»OOM(Out Of Memory Killer)ã€‚å®¹å™¨å¥—é¤4c8gï¼Œtopçœ‹å å†…å­˜æœ€å¤šçš„è¿›ç¨‹å¤§çº¦17må·¦å³ï¼Œæ€»å…±100ä¸ªï¼Œæ€»å†…å­˜ä¹Ÿä¸åˆ°2gï¼Œä½†æ˜¯memory.usage_in_byteså·²ç»è¾¾åˆ°8gï¼ˆfreeçœ‹ä¹Ÿæ˜¯ä¸€æ ·ï¼‰ï¼Œcacheä¹Ÿåªæœ‰å‡ ç™¾å…†ï¼Œä¹…è€Œä¹…ä¹‹ï¼Œcacheæ‰€å å†…å­˜ä¹Ÿè¢«è€—å°½ï¼Œå®¹å™¨å†…è¿›ç¨‹oomï¼Œå®é™…å¯ç”¨å†…å­˜ä¸åˆ°1gã€‚åœ¨è¿™è®°å½•ä¸‹é—®é¢˜æ’æŸ¥è¿‡ç¨‹ã€‚</p>
<h1 id="æ’æŸ¥é—®é¢˜å®¹å™¨ç¯å¢ƒ">æ’æŸ¥é—®é¢˜å®¹å™¨ç¯å¢ƒ</h1>
<p>ç”±äºè¾¾åˆ°oomçš„ç°åœºå·²ç»ä¸åœ¨ï¼Œç°åœ¨ä½¿ç”¨ä¸‹é¢çš„åœºæ™¯è¿›è¡Œæ¼”ç¤ºï¼š
å®¹å™¨å¥—é¤4c8gï¼Œworking_setå†…å­˜6.8gï¼ˆå®¹å™¨å†…ä¸€èˆ¬ç”¨working_setæ¥è¯„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œworking_set=rss+æ´»è·ƒçš„cacheï¼‰ï¼Œrss600mï¼Œcache1.7gï¼Œä¸šåŠ¡è¿›ç¨‹ä½¿ç”¨2gã€‚ç›®å‰working_setè¿œå°äºrss+cacheã€‚</p>
<h1 id="æ’æŸ¥è¿‡ç¨‹">æ’æŸ¥è¿‡ç¨‹</h1>
<ol>
  <li>è¿›å®¹å™¨çœ‹çœ‹ä¸šåŠ¡è¿›ç¨‹æ¶ˆè€—èµ„æº
docker execè¿›åˆ°å®¹å™¨topåè¾“å…¥Mï¼ˆå¤§å†™Mï¼‰ï¼ŒæŸ¥çœ‹æ¶ˆè€—å†…å­˜æœ€å¤šçš„è¿›ç¨‹
```
top - 15:12:57 up 7 days,  1:00,  1 user,  load average: 0.24, 0.08, 0.02
Tasks: 145 total,   1 running, 144 sleeping,   0 stopped,   0 zombie
Cpu(s):  1.0%us,  0.0%sy,  0.0%ni, 99.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Mem:   8192000k total,  7724968k used,   467032k free,        0k buffers
Swap:        0k total,        0k used,        0k free,  1745040k cached</li>
</ol>

<p>PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                   204 root      20   0 2527m  19m 3140 S  0.0  0.2   0:43.40 docker-qalarm                                          <br />
35382 nobody    20   0  306m  17m 9.8m S  0.0  0.2   0:20.51 php-fpm                                                <br />
35373 nobody    20   0  306m  17m 9984 S  0.0  0.2   0:20.88 php-fpm                                                <br />
35444 nobody    20   0  306m  17m 9964 S  0.0  0.2   0:20.55 php-fpm                                                <br />
35350 nobody    20   0  306m  17m 9936 S  0.0  0.2   0:20.44 php-fpm                                                <br />
35407 nobody    20   0  306m  17m 9976 S  0.0  0.2   0:20.22 php-fpm                                                <br />
35392 nobody    20   0  306m  17m 9924 S  0.0  0.2   0:20.33 php-fpm                                                <br />
35368 nobody    20   0  306m  17m 9916 S  0.0  0.2   0:20.22 php-fpm                                                <br />
35398 nobody    20   0  306m  17m 9908 S  0.0  0.2   0:20.27 php-fpm                                                <br />
35357 nobody    20   0  306m  17m 9912 S  0.3  0.2   0:20.94 php-fpm                                                <br />
35463 nobody    20   0  306m  17m 9912 S  0.0  0.2   0:20.22 php-fpm                                                <br />
35437 nobody    20   0  306m  17m 9900 S  0.0  0.2   0:21.09 php-fpm                                                <br />
35464 nobody    20   0  306m  17m 9896 S  0.0  0.2   0:20.46 php-fpm                                                <br />
35384 nobody    20   0  306m  17m 9888 S  0.3  0.2   0:19.90 php-fpm                                                <br />
35348 nobody    20   0  306m  17m 9876 S  0.0  0.2   0:20.53 php-fpm                                                <br />
35365 nobody    20   0  306m  17m 9880 S  0.0  0.2   0:20.71 php-fpm                                                <br />
35358 nobody    20   0  306m  17m 9868 S  0.0  0.2   0:20.42 php-fpm                                                <br />
35420 nobody    20   0  306m  17m 9892 S  0.0  0.2   0:19.88 php-fpm                                                <br />
35424 nobody    20   0  306m  17m 9864 S  0.0  0.2   0:20.52 php-fpm                                                <br />
35389 nobody    20   0  306m  17m 9872 S  0.0  0.2   0:20.18 php-fpm                                                <br />
35335 nobody    20   0  306m  17m 9908 S  0.0  0.2   0:20.84 php-fpm                                                <br />
35468 nobody    20   0  306m  17m 9912 S  0.3  0.2   0:20.58 php-fpm</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code></code></pre></div></div>
<p>[root@robot-speaker-e862e0-7c84fb65cd-whv5d /home/q/system/speaker-robot]# ps -ef | grep php-fpm|grep -v grep|wc -l
129</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å‘ç°ä½¿ç”¨å†…å­˜æœ€å¤šçš„php-fpm è¿›ç¨‹ç”¨äº†17Mï¼Œ129ä¸ªè¿›ç¨‹ï¼Œä¸€å…±ä½¿ç”¨å†…å­˜2.1gã€‚å†…å­˜ä½¿ç”¨äº†7.4gã€æœªä½¿ç”¨450Mã€cache1.7gï¼ˆæˆ‘ä»¬ä½¿ç”¨äº†lxcfsåšå®¹å™¨è§†å›¾éš”ç¦»ï¼Œæ‰€ä»¥å†…å­˜æ˜¾ç¤ºçš„æ˜¯å®¹å™¨çš„çœŸå®æƒ…å†µï¼‰ï¼Œè¿˜æœ‰5gå·¦å³å†…å­˜å»å“ªäº†
2ã€è¿›åˆ°å†…å­˜å®¹å™¨cgroup
</code></pre></div></div>
<p>7af95a9ac99dd32c8bc51aa4531f75a836d1b5e6c29]# ls
cgroup.clone_children           memory.kmem.tcp.max_usage_in_bytes  memory.oom_control
cgroup.event_control            memory.kmem.tcp.usage_in_bytes      memory.pressure_level
cgroup.procs                    memory.kmem.usage_in_bytes          memory.soft_limit_in_bytes
memory.failcnt                  memory.limit_in_bytes               memory.stat
memory.force_empty              memory.max_usage_in_bytes           memory.swappiness
memory.kmem.failcnt             memory.memsw.failcnt                memory.usage_in_bytes
memory.kmem.limit_in_bytes      memory.memsw.limit_in_bytes         memory.use_hierarchy
memory.kmem.max_usage_in_bytes  memory.memsw.max_usage_in_bytes     notify_on_release
memory.kmem.slabinfo            memory.memsw.usage_in_bytes         tasks
memory.kmem.tcp.failcnt         memory.move_charge_at_immigrate
memory.kmem.tcp.limit_in_bytes  memory.numa_stat
[root@docker123 /sys/fs/cgroup/memory/kubepods/burstable/pod6e726ccc-1d6f-11ea-851f-fa163e9a7739/45bb864dfe68379c6d2f07af95a9ac99dd32c8bc51aa4531f75a836d1b5e6c29]#</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- æŸ¥çœ‹ memory.usage_in_bytes
</code></pre></div></div>
<p>7af95a9ac99dd32c8bc51aa4531f75a836d1b5e6c29]# cat  memory.usage_in_bytes
7934582784</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ç¡®å®æ˜¯7gå¤š
- æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µmemory.stat
</code></pre></div></div>
<p>7af95a9ac99dd32c8bc51aa4531f75a836d1b5e6c29]# cat memory.stat
cache 1806925824
rss 622092288
rss_huge 287309824
mapped_file 20508672
swap 0
pgpgin 17583007
pgpgout 17135620
pgfault 48558141
pgmajfault 1180
inactive_anon 17465344
active_anon 628965376
inactive_file 1058193408
active_file 724385792
unevictable 0
hierarchical_memory_limit 8388608000
hierarchical_memsw_limit 16777216000
total_cache 1806925824
total_rss 622092288
total_rss_huge 287309824
total_mapped_file 20508672
total_swap 0
total_pgpgin 17583007
total_pgpgout 17135620
total_pgfault 48558141
total_pgmajfault 1180
total_inactive_anon 17465344
total_active_anon 628965376
total_inactive_file 1058193408
total_active_file 724385792
total_unevictable 0</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>æ²¡æœ‰å ç”¨å†…å­˜ç‰¹åˆ«å¤§çš„é¡¹ï¼Œä¹Ÿå°±æ˜¯è¿œæ²¡è¾¾åˆ°topæ‰€è§ã€‚å¦å¤–å¿˜è®°è¯´ï¼Œä¸Šè¾¹å•ä½éƒ½æ˜¯å­—èŠ‚

- æŸ¥çœ‹å®¹å™¨çš„å†…æ ¸å†…å­˜ä½¿ç”¨é‡memory.kmem.usage_in_bytes
</code></pre></div></div>
<p>7af95a9ac99dd32c8bc51aa4531f75a836d1b5e6c29]# cat memory.kmem.usage_in_bytes
5513891840</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>æœç„¶æ˜¯5g
- ç°åœ¨çœ‹ä¸‹å®¹å™¨ä½¿ç”¨å†…æ ¸slabæƒ…å†µmemory.kmem.slabinfo
</code></pre></div></div>
<p>7af95a9ac99dd32c8bc51aa4531f75a836d1b5e6c29]# cat memory.kmem.slabinfo
slabinfo - version: 2.1
â€¦
taskstats           1960   1960    328   49    4 : tunables    0    0    0 : slabdata     40     40      0
xfs_ili           3945336 3945336    168   48    2 : tunables    0    0    0 : slabdata  82195  82195      0
xfs_btree_cur       1560   1560    208   39    2 : tunables    0    0    0 : slabdata     40     40      0
posix_timers_cache  16071  16071    248   33    2 : tunables    0    0    0 : slabdata    487    487      0
scsi_cmd_cache      1440   1440    448   36    4 : tunables    0    0    0 : slabdata     40     40      0
xfs_log_ticket      1760   1760    184   44    2 : tunables    0    0    0 : slabdata     40     40      0
cfq_queue           1400   1400    232   35    2 : tunables    0    0    0 : slabdata     40     40      0
inode_cache         2200   2200    592   55    8 : tunables    0    0    0 : slabdata     40     40      0
radix_tree_node    35635  39984    584   28    4 : tunables    0    0    0 : slabdata   1428   1428      0
bio-2               2040   2040    320   51    4 : tunables    0    0    0 : slabdata     40     40      0
fanotify_event_info   2920   2920     56   73    1 : tunables    0    0    0 : slabdata     40     40      0
blkdev_ioc          1560   1560    104   39    1 : tunables    0    0    0 : slabdata     40     40      0
xfs_inode         3959772 3959772    960   34    8 : tunables    0    0    0 : slabdata 116478 116478      0
Acpi-ParseExt       2240   2240     72   56    1 : tunables    0    0    0 : slabdata     40     40      0
â€¦</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å¯ä»¥çœ‹å‡ºå…³äºæ–‡ä»¶å…ƒæ•°æ®ç¼“å­˜å°±å äº†4gå¤šï¼Œä¸Šå›¾ç¬¬ä¸‰åˆ—æ˜¯å¯¹è±¡æ•°é‡ï¼Œç¬¬å››åˆ—æ˜¯å¯¹è±¡å¤§å°ï¼Œæ‰€ä»¥xfs_inodeå ç”¨å†…å­˜=3959772 * 960 /1024/1024/1024,çº¦ç­‰äº3.5gï¼Œxfs_ili 0.7gï¼Œè¿™å·²ç»4gå¤šäº†ã€‚æ‰€ä»¥åŸºæœ¬å¯ä»¥æ–­å®šæ˜¯ä¸šåŠ¡è¿›ç¨‹æ“ä½œæ–‡ä»¶å¤šè¿‡å¯¼è‡´
- æŸ¥çœ‹å®¹å™¨å†…æ˜¯å¦æœ‰å¤§é‡å°æ–‡ä»¶
</code></pre></div></div>
<p>[root@robot-speaker-e862e0-7c84fb65cd-whv5d /data/php/session]# ls -lR | grep â€œ^-â€œ| wc -l
3941117
```
å¯è§sessionæ–‡ä»¶æ•°ä¸slabä¸­çš„xfs_inodeåŸºæœ¬ç›¸å½“ï¼Œæ‰€ä»¥å¯ä»¥æ–­å®šç½ªé­ç¥¸é¦–åœ¨æ­¤</p>
<ul>
  <li>éšç€sessionæ–‡ä»¶è¶Šæ¥è¶Šå¤šï¼Œxfs_inodeå ç”¨slabå†…å­˜è¶Šæ¥è¶Šå¤šï¼Œä¸å¯å›æ”¶SUnreclaimä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ï¼Œæ‰€ä»¥æœ€ç»ˆä¼šå¯¼è‡´å¯ç”¨å†…å­˜è¶Šæ¥è¶Šå°‘
    <h1 id="éªŒè¯ç»“æœ">éªŒè¯ç»“æœ</h1>
    <p>ç»è¿‡ä¸ä¸šåŠ¡æ²Ÿé€šï¼Œä»–ä»¬æ¸…ç†çš„å¤§é‡sessionæ–‡ä»¶åï¼Œslabå†…å­˜æ˜æ˜¾é™ä¸‹æ¥äº†ã€‚
<img src="https://upload-images.jianshu.io/upload_images/14774548-8ac72bca565ccc45.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png" /></p>
  </li>
</ul>

<h1 id="ç»“è®º">ç»“è®º</h1>
<ol>
  <li>ä¸šåŠ¡åº”å°½å¯èƒ½çš„é¿å…è¿™ç§ä¸Šç™¾ä¸‡çº§åˆ«çš„å°æ–‡ä»¶</li>
  <li>æ›´ä¼˜é›…çš„æ–¹å¼æ˜¯é™åˆ¶å®¹å™¨å†…å¯ç”¨å†…æ ¸ç¼“å­˜çš„æ¯”ä¾‹ï¼ˆè¿˜åœ¨å°è¯•ï¼‰
    <h1 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h1>
    <p><a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/6/html/resource_management_guide/sec-memory">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/6/html/resource_management_guide/sec-memory</a>
<a href="https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v1/memory.html">https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v1/memory.html</a>
<a href="https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v2.html">https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v2.html</a></p>
  </li>
</ol>

:ET