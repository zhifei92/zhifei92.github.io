I"½&<h1 id="æ¦‚è¿°">æ¦‚è¿°</h1>
<p>Â Â Â Â Â Â Â Â æˆ‘ä»¬éƒ¨ç½²çš„ç‰ˆæœ¬æ˜¯æ­¤ç¯‡æ–‡ç« å‘å¸ƒæ—¶ElastAlertï¼ˆV0.2.1ï¼‰ã€ElastAlert serverï¼ˆ3.0.0-beta.0ï¼‰ ã€elastalert-kibana-pluginï¼ˆ1.1.0ï¼‰çš„æœ€æ–°ç‰ˆæœ¬ã€‚eså’Œkibanaçš„ç‰ˆæœ¬æ˜¯7.2.0ã€‚ESå’Œkibanaéƒ¨ç½²ä¸æ˜¯æœ¬ç¯‡çš„é‡ç‚¹ï¼Œè¿™é‡Œä¸åšä»‹ç»ã€‚
Â Â Â Â Â Â Â Â å…¥æ­£é¢˜ä¹‹å‰å¾—å…ˆè¯´ä¸‹ESï¼ŒElasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€å¯æ‰©å±•ã€å®æ—¶çš„æœç´¢ä¸æ•°æ®åˆ†æå¼•æ“ã€‚ å®ƒèƒ½ä»é¡¹ç›®ä¸€å¼€å§‹å°±èµ‹äºˆä½ çš„æ•°æ®ä»¥æœç´¢ã€åˆ†æå’Œæ¢ç´¢çš„èƒ½åŠ›ã€‚æˆ‘ä»¬å®¹å™¨æœåŠ¡çš„æ—¥å¿—ç°åœ¨å¤§å¤šæ•°éƒ½å…¥åˆ°äº†qbusï¼Œç„¶åå¯ä»¥ç”¨esæ¶ˆè´¹ï¼Œé€šè¿‡kibanaæ–¹ä¾¿çš„æŸ¥çœ‹æ—¥å¿—ã€‚ä½†æ˜¯è´Ÿè´£esçš„åŒäº‹å’Œæˆ‘ä»¬éƒ½æ²¡æœ‰æ”¯æŒæ—¥å¿—å‘Šè­¦ï¼Œç›®å‰æ˜¯ä¸€ä¸ªçŸ­æ¿ã€‚X-Packæä¾›äº†æŠ¥è­¦ç»„ä»¶Alertï¼Œä½†æ˜¯è¿™ä¸ªåŠŸèƒ½æ˜¯éœ€è¦ä»˜è´¹ï¼ŒElastAlertèƒ½å¤Ÿå®Œç¾æ›¿ä»£Alertæä¾›çš„æ‰€æœ‰åŠŸèƒ½ã€‚ElastAlertç›®å‰æœ‰6k+starï¼Œç»´æŠ¤è¾ƒå¥½å¾ˆå—æ¬¢è¿ï¼Œä½¿ç”¨pythonç¼–å†™ï¼ŒV0.2.0ä»¥åä½¿ç”¨python3ï¼Œpython2ä¸å†ç»´æŠ¤ï¼Œä»¥è‡´åœ¨è™šæœºç‰©ç†æœºéƒ¨ç½²çš„å‘å¾ˆå¤šï¼Œæœ€ç»ˆä¹Ÿæ˜¯ä»¥å®¹å™¨çš„æ–¹å¼æˆåŠŸæ­å»ºã€‚å› ä¸ºå…¬å¸esä¹‹åè¦å‡çº§åˆ°7.2ç‰ˆæœ¬ï¼ŒElastAlertV0.2.1ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰æ‰å¯¹es7æ”¯æŒçš„å¾ˆå¥½ï¼Œelastalert-kibana-pluginæœ€æ–°ç‰ˆæœ¬æ‰æ”¯æŒkibana7ã€‚</p>
<h1 id="ç›¸å…³ç»„ä»¶">ç›¸å…³ç»„ä»¶</h1>
<ul>
  <li>å‘Šè­¦æœåŠ¡ElastAlertï¼Œç‰ˆæœ¬V0.2.1</li>
  <li>å±•ç¤ºæ’ä»¶elastalert-kibana-pluginï¼Œkibanaå®‰è£…è¿™ä¸ªç»„ä»¶åï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡kibanaç®¡ç†å‘Šè­¦è§„åˆ™ï¼ˆå¢ã€åˆ ã€æ”¹ã€æŸ¥ï¼ŒåŠæµ‹è¯•ï¼‰ã€‚</li>
  <li>apiæœåŠ¡ElastAlert  serverï¼Œæš´éœ²restf apiæä¾›ç®¡ç†å‘Šè­¦è§„åˆ™çš„èƒ½åŠ›ï¼Œä¸elastalert-kibana-pluginé…åˆä½¿ç”¨ã€‚è¿™ä¸ªæœåŠ¡å¯åŠ¨æ—¶åŒæ—¶å¯åŠ¨ElastAlertã€‚</li>
</ul>

<p>elastalert-kibana-pluginå¯¹ES6.3å¼€å§‹æä¾›æ”¯æŒï¼Œå…¬å¸ç›®å‰ä½¿ç”¨çš„æ˜¯ES6.2ï¼Œä¹‹åè¦å‡çº§åˆ°ES7ï¼Œæ‰€ä»¥ElastAlertç”¨V0.2.1ï¼ŒElastAlert  server 3.0.0-beta.0,elastalert-kibana-plugin 1.1.0ã€‚</p>
<h1 id="æ­å»º">æ­å»º</h1>
<p>Â Â Â Â Â Â Â Â ElastAlert V0.2.1éœ€è¦python3ï¼Œç›®å‰æˆ‘ä»¬ä½¿ç”¨linuxå†…æ ¸éƒ½ä¼šé»˜è®¤è£…python2ï¼Œå®‰è£…python3åï¼Œä½¿ç”¨æ··åˆç¯å¢ƒå®‰è£…ElastAlert å¾ˆå¤šä¾èµ–è£…ä¸æˆåŠŸï¼Œäº¦æˆ–è£…æˆåŠŸåæ¨¡å—æœ‰æ‰¾ä¸åˆ°ï¼Œæ‰€ä»¥æœ€ç»ˆæ‰“ç®—ä½¿ç”¨docker multi stage buildæ–¹å¼æ„å»ºElastAlert  serveré•œåƒï¼Œä»¥å®¹å™¨çš„æ–¹å¼å¯åŠ¨ã€‚
Â Â Â Â Â Â Â Â å®˜ç½‘ä¸Šæä¾›äº†ElastAlert  serveré•œåƒæ„å»ºæ–¹å¼ï¼Œä½†å¾ˆä¹…ä¸ç»´æŠ¤ï¼Œè¿˜æ˜¯ä½¿ç”¨python2æ„å»ºçš„è€çš„ç‰ˆæœ¬ã€‚æˆ‘ä»¬éœ€è¦é‡æ–°æ„å»ºã€‚</p>
<ol>
  <li>git cloneÂ <a href="https://github.com/bitsensor/elastalert.git">https://github.com/bitsensor/elastalert.git</a>Â &amp;&amp;Â cdÂ elastalertÂ  ä¿®æ”¹Â Â Dockerfileã€‚è¿™ä¸€æ­¥å¾ˆé‡è¦ä¸‹è½½çš„æ˜¯elastalert serverï¼Œä¸æ˜¯elastalertï¼Œelastalertåªéœ€åœ¨Dockerfileä¸­æŒ‡å®šç‰ˆæœ¬ï¼Œç›´æ¥ä¸‹è½½zipåŒ…ã€‚</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM python:3.6-alpine as pyea
ENV ELASTALERT_VERSION=v0.2.1
# URL from which to download Elastalert.
ENV ELASTALERT_URL=https://github.com/Yelp/elastalert/archive/$ELASTALERT_VERSION.zip
# Elastalert home directory full path.
ENV ELASTALERT_HOME /opt/elastalert
WORKDIR /opt
RUN apk add --update --no-cache ca-certificates openssl-dev openssl libffi-dev gcc musl-dev wget &amp;&amp; \
# Download and unpack Elastalert.
    wget -O elastalert.zip "${ELASTALERT_URL}" &amp;&amp; \
    unzip elastalert.zip &amp;&amp; \
    rm elastalert.zip &amp;&amp; \
    mv e* "${ELASTALERT_HOME}"
WORKDIR "${ELASTALERT_HOME}"
# Install Elastalert.
# see: https://github.com/Yelp/elastalert/issues/1654
RUN python setup.py install &amp;&amp; \
    pip install -r requirements.txt &amp;&amp; \
    pip install elasticsearch==7.0.0
FROM node:alpine
#LABEL maintainer="BitSensor &lt;dev@bitsensor.io&gt;"
# Set timezone for this container
ENV TZ Etc/UTC
 
RUN apk add --update --no-cache curl tzdata python3 make libmagic
COPY --from=pyea /usr/local/lib/python3.6/site-packages /usr/lib/python3.6/site-packages
#COPY --from=pyea /usr/lib/python3.6/site-packages /usr/lib/python3.6/site-packages
COPY --from=pyea /opt/elastalert /opt/elastalert
COPY --from=pyea /usr/local/bin/elastalert* /usr/bin/
WORKDIR /opt/elastalert-server
COPY . /opt/elastalert-server
#RUN mkdir -p /usr/local/lib/python3.7 /usr/lib/python3.7 &amp;&amp; \
#    cp /usr/local/lib/python3.6/site-packages /usr/local/lib/python3.7/site-packages\
#    cp /usr/local/lib/python3.6/site-packages /usr/lib/python3.7
RUN ln -s /usr/bin/python3 /usr/bin/python
RUN npm install --production --quiet
COPY config/elastalert.yaml /opt/elastalert/config.yaml
COPY config/elastalert-test.yaml /opt/elastalert/config-test.yaml
COPY config/config.json config/config.json
COPY rule_templates/ /opt/elastalert/rule_templates
COPY elastalert_modules/ /opt/elastalert/elastalert_modules
# Add default rules directory
# Set permission as unpriviledged user (1000:1000), compatible with Kubernetes
RUN mkdir -p /opt/elastalert/rules/ /opt/elastalert/server_data/tests/ \
    &amp;&amp; chown -R node:node /opt
USER node
EXPOSE 3030
ENTRYPOINT ["npm", "start"]
</code></pre></div></div>

<ol>
  <li>åˆ¶ä½œé•œåƒï¼šdocker build â€“no-cache  -t   image-name  .</li>
</ol>

<p>æ³¨ï¼šbuildçš„æ—¶å€™å¯èƒ½ä¼šæŠ¥layeræ‰¾ä¸åˆ°çš„é”™è¯¯ï¼Œå†buildä¸€æ¬¡å°±å¯ä»¥äº†ï¼ˆå†æ¬¡buildæ—¶ä¸è¦åŠ â€“no-cacheï¼‰ï¼ˆç›®å‰æ²¡æœ‰ç»†è·ŸåŸå› ï¼‰</p>

<ol>
  <li>è¿è¡Œ</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d -p 3030:3030 -p 3333:3333 \
    -v `pwd`/config/elastalert.yaml:/opt/elastalert/config.yaml \
    -v `pwd`/config/elastalert-test.yaml:/opt/elastalert/config-test.yaml \
    -v `pwd`/config/config.json:/opt/elastalert-server/config/config.json \
    -v `pwd`/rules:/opt/elastalert/rules \
    -v `pwd`/rule_templates:/opt/elastalert/rule_templates \
    --net="host" \
    --name elastalert images-name
</code></pre></div></div>

<p>é€šè¿‡docker logs elastalert -f æŸ¥çœ‹æ—¥ä¹‹æ—¥ï¼Œå¦‚æœæŠ¥é”™ï¼ŒæŒ‡å®šå‘Šè­¦çº§åˆ«ä¸ºdubugæŸ¥çœ‹é”™è¯¯ä¿¡æ¯</p>

<ol>
  <li>ä¸»è¦çš„é…ç½®æ–‡ä»¶ï¼š</li>
</ol>

<ul>
  <li>elastalert.yamlï¼šelastalerté…ç½®æ–‡ä»¶ï¼Œesç›¸å…³é…ç½®</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
# This is the folder that contains the rule yaml files
# Any .yaml file will be loaded as a rule
rules_folder: rules
# How often ElastAlert will query Elasticsearch
# The unit can be anything from weeks to seconds
run_every:
  minutes: 1
# ElastAlert will buffer results from the most recent
# period of time, in case some log sources are not in real time
buffer_time:
  minutes: 15
# The Elasticsearch hostname for metadata writeback
# Note that every rule can have its own Elasticsearch host
es_host: 10.216.6.76
# The Elasticsearch port
es_port: 9200
es_username: tfmaq
es_password: 4152adc2a11cb182c014bc95
# The index on es_host which is used for metadata storage
# This can be a unmapped index, but it is recommended that you run
# elastalert-create-index to set a mapping
writeback_index: hihi_test
#writeback_alias: elastalert_alerts
# If an alert fails for some reason, ElastAlert will retry
# sending the alert until this time period has elapsed
alert_time_limit:
  days: 2
</code></pre></div></div>

<ul>
  <li>config.jsonï¼šelastalert serverçš„é…ç½®æ–‡ä»¶</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
{
  "appName": "elastalert-server",
  "port": 3030,
  "wsport": 3333,
  "elastalertPath": "/opt/elastalert",
  "verbose": false,
  "es_debug": false,
  "debug": false,
  "rulesPath": {
    "relative": true,
    "path": "/rules"             # é€šè¿‡kibanaæ’ä»¶åˆ›å»ºçš„é…ç½®æ–‡ä»¶éƒ½å­˜åœ¨è¿™
  },
  "templatesPath": {
    "relative": true,
    "path": "/rule_templates"
  },
  "es_host": "10.216.6.76",      # es ip
  "es_port": 9200,               # es ç«¯å£
  "writeback_index": "hihi_test" # ç›‘æ§çš„esindex
}
</code></pre></div></div>

<ul>
  <li>rulesï¼šæ‰€æœ‰æŠ¥è­¦è§„åˆ™çš„é…ç½®æ–‡ä»¶éƒ½å­˜åœ¨ç€,test-rule.yaml</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
es_host: 10.216.6.76

es_port: 9200

es_username: tfmaq
es_password: 4152adc2a11cb182c014bc952xxx
name: Example frequency rule 2

type: frequency

index: hihi-test

num_events: 5

timeframe:
  hours: 4

filter:
- query:
   query_string:
     query: "type:access"  # æŸ¥è¯¢è§„åˆ™æ ¹æ®æ—¥å¿—ï¼Œè‡ªè¡Œé…ç½®
     query: "message:error"  #

alert:
- "email"

email:
- "zhangzhifei@360.cn" 
</code></pre></div></div>

<ul>
  <li>è¯¦ç»†çš„é…ç½®è§„åˆ™å¤§å®¶çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œç…§ç€æˆ‘è¿™ä¹ˆé…ç½®å…ˆæŠŠå‘Šè­¦å‘å‡ºæ¥</li>
</ul>

<ol>
  <li>å®‰è£…kibana</li>
</ol>

<p>æŒ‰ç…§ç½‘å…³æŒ‰å³å¯ï¼Œç‰ˆæœ¬è¦å¯¹ä¸Š<a href="https://github.com/bitsensor/elastalert-kibana-plugin">https://github.com/bitsensor/elastalert-kibana-plugin</a></p>

<h1 id="kibanaå±•ç¤º">kibanaå±•ç¤º</h1>

<p>kibanaæ’ä»¶å¦‚ä¸‹ï¼š
<img src="https://upload-images.jianshu.io/upload_images/14774548-28d28f3c2e2a7876.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png" />
custom_frequencyæ˜¯å¯æœåŠ¡ä¹‹å‰åˆ›å»ºçš„é…ç½®æ–‡ä»¶ï¼Œtestå’Œtest2æ˜¯é€šè¿‡kibana dashboardåˆ›å»ºã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡â€œåˆ›å»ºâ€-â€œæµ‹è¯•â€-â€œä¿å­˜â€è¿™ä¸€æµç¨‹æ–°å»ºalert rules å’Œæˆ‘ä»¬çš„hulkå®¹å™¨ä¸Šçš„è‡ªå®šä¹‰å‘Šè­¦æµç¨‹å·®ä¸å¤š
<img src="https://upload-images.jianshu.io/upload_images/14774548-ca24e86e65dfb74a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png" /></p>

<h1 id="å‚è€ƒ">å‚è€ƒ</h1>

<p><a href="https://github.com/bitsensor/elastalert">https://github.com/bitsensor/elastalert</a></p>

<p><a href="https://github.com/bitsensor/elastalert-kibana-plugin">https://github.com/bitsensor/elastalert-kibana-plugin</a></p>

<p><a href="https://github.com/Yelp/elastalert">https://github.com/Yelp/elastalert</a></p>

<p><a href="https://elastalert.readthedocs.io/en/latest/">https://elastalert.readthedocs.io/en/latest/</a></p>

:ET